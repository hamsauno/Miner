<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/bg.css">
  <script src="js/fullscr.js" defer></script>
  <script src="js/nozoom.js" defer></script>
</head>
<body class="bg-white text-black font-[Arial]">
<!-- Блок высотой 140px -->
<div class="w-full bg-[#E2E2E2] text-black text-xs sm:text-sm px-4 py-2 overflow-y-auto flex flex-col justify-between" style="height: 140px;">
    <div class="space-y-2 leading-relaxed">
      <div class="grid grid-cols-[auto,1fr] gap-2">
        <p class="text-right"><strong>Офис :</strong></p>
        <p>
          <button class="underline hover:text-blue-600 text-left" onclick="openMap('https://yandex.ru/maps/org/waymorr/39016942329/?ll=37.576007%2C55.772289&z=17.12')">
            Электрический переулок, 3/10с1
          </button>
        </p>
      </div>
  
      <div class="grid grid-cols-[auto,1fr] gap-2">
        <p class="text-right"><strong>Склад :</strong></p>
        <p>
          <button class="underline hover:text-blue-600 text-left" onclick="openMap('https://yandex.ru/maps/213/moscow/house/krasnokazarmennaya_ulitsa_12s38/Z04YcQdgQUUGQFtvfXt0d31hZw==/?ll=37.700801%2C55.756123&z=17.12')">
            Красноказарменная улица, 12с38
          </button>
        </p>
      </div>
  
      <div class="grid grid-cols-[auto,1fr] gap-2">
        <p class="text-right"><strong>Телефон :</strong></p>
        <p>
          <a href="tel:+74951297535" class="underline hover:text-blue-600" target="_blank" rel="noopener noreferrer">+7 (495) 129-75-35</a>
        </p>
      </div>
    </div>
  
<!-- Кнопка "Заказать звонок" -->
<div class="w-full text-center">
  <a id="callOrderBtn"
     href="#"
     class="mt-2 block text-center bg-[#2511A8] text-white text-base font-semibold py-2 w-full">
    Заказать звонок
  </a>
</div>

<!-- Модальное окно -->
<div id="modalOverlay" class="fixed top-0 left-0 w-full h-[140px] bg-black bg-opacity-50 z-50 hidden">
  <div class="bg-[#E2E2E2] w-full h-full px-4 pt-2 box-border">
    <h2 class="text-sm font-semibold mb-1">Введите номер телефона</h2>
    <div class="flex items-center space-x-2 mb-1">
      <span class="text-lg font-bold">+7</span>
      <input type="tel" id="userPhone" class="w-full px-2 py-1 border text-sm" placeholder="999-222-55-77">
    </div>
    <div class="flex items-center mb-1">
      <input type="checkbox" id="savePhone" class="mr-2">
      <span class="text-sm">Сохранить номер</span>
    </div>
    <div class="flex justify-between space-x-2">
      <button id="cancelBtn" class="bg-[#2511A8] text-white px-4 py-1 w-1/2 text-sm rounded-none">Отменить</button>
      <button id="submitBtn" class="bg-[#2511A8] text-white px-4 py-1 w-1/2 text-sm rounded-none" disabled>Отправить</button>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://yiprwrgmyqlkdmhgulmc.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpcHJ3cmdteXFsa2RtaGd1bG1jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ2NTI0NjgsImV4cCI6MjA2MDIyODQ2OH0.lfiTfr5ukGDEVuwq-X9U2kWs3nEZrp3N443HT5AkbfI"
);

document.addEventListener("DOMContentLoaded", async () => {
  const tg = window.Telegram?.WebApp;
  tg?.ready();

  const user = tg?.initDataUnsafe?.user;
  if (!user) {
    alert("❗️ Откройте через Telegram.");
    return;
  }

  const telegramId = user.id.toString();
  const username = user.username || "";

  const modal = document.getElementById("modalOverlay");
  const phoneInput = document.getElementById("userPhone");
  const saveCheckbox = document.getElementById("savePhone");
  const submitBtn = document.getElementById("submitBtn");
  const cancelBtn = document.getElementById("cancelBtn");

  // Кнопка "Заказать звонок"
  document.getElementById("callOrderBtn").addEventListener("click", (e) => {
    e.preventDefault();
    modal.classList.remove("hidden");
  });

  // Автоактивация кнопки "Отправить"
  phoneInput.addEventListener("input", () => {
    const digits = phoneInput.value.replace(/\D/g, "");
    submitBtn.disabled = digits.length !== 10;
  });

  // Получаем телефон из БД, если есть
  let savedPhone = "";
  try {
    const { data, error } = await supabase
      .from("users")
      .select("phone")
      .eq("telegram_id", telegramId)
      .single();

    if (error) {
      console.warn("Пользователь не найден:", error.message);
      modal.classList.remove("hidden");
    } else if (data?.phone) {
      savedPhone = data.phone;
      const msg = `POZVONI_MNE_${savedPhone}`;
      tg.openTelegramLink(`https://t.me/WAYMORR_BOT?start=${msg}`);
    } else {
      modal.classList.remove("hidden");
    }
  } catch (err) {
    console.error("Ошибка при получении телефона:", err);
    modal.classList.remove("hidden");
  }

  cancelBtn.addEventListener("click", () => {
    modal.classList.add("hidden");
  });

  submitBtn.addEventListener("click", async () => {
    let phone = phoneInput.value.trim();
    const normalizedPhone = phone.replace(/\D/g, "");

    if (!/^\d{10}$/.test(normalizedPhone)) {
      alert("Введите корректный номер (10 цифр после +7).");
      return;
    }

    if (saveCheckbox.checked) {
      const { error } = await supabase
        .from("users")
        .upsert({ telegram_id: telegramId, username, phone: normalizedPhone }, { onConflict: ['telegram_id'] });

      if (error) {
        console.error("Ошибка при сохранении телефона:", error.message);
      } else {
        console.log("Телефон сохранён.");
      }
    }

    const msg = `POZVONI_MNE_${normalizedPhone}`;
    tg.openTelegramLink(`https://t.me/WAYMORR_BOT?start=${msg}`);
  });
});

</script>





  
  
  <script>
    function openMap(url) {
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.openLink(url);
      } else {
        window.open(url, '_blank');
      }
    }
  </script>
</body>
</html>


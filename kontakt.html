<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/bg.css">
  <script src="js/fullscr.js" defer></script>
  <script src="js/nozoom.js" defer></script>
</head>
<body class="bg-white text-black font-[Arial]">
<!-- Блок высотой 140px -->
<div class="w-full bg-[#E2E2E2] text-black text-xs sm:text-sm px-4 py-2 overflow-y-auto flex flex-col justify-between" style="height: 140px;">
    <div class="space-y-2 leading-relaxed">
      <div class="grid grid-cols-[auto,1fr] gap-2">
        <p class="text-right"><strong>Офис :</strong></p>
        <p>
          <button class="underline hover:text-blue-600 text-left" onclick="openMap('https://yandex.ru/maps/org/waymorr/39016942329/?ll=37.576007%2C55.772289&z=17.12')">
            Электрический переулок, 3/10с1
          </button>
        </p>
      </div>
  
      <div class="grid grid-cols-[auto,1fr] gap-2">
        <p class="text-right"><strong>Склад :</strong></p>
        <p>
          <button class="underline hover:text-blue-600 text-left" onclick="openMap('https://yandex.ru/maps/213/moscow/house/krasnokazarmennaya_ulitsa_12s38/Z04YcQdgQUUGQFtvfXt0d31hZw==/?ll=37.700801%2C55.756123&z=17.12')">
            Красноказарменная улица, 12с38
          </button>
        </p>
      </div>
  
      <div class="grid grid-cols-[auto,1fr] gap-2">
        <p class="text-right"><strong>Телефон :</strong></p>
        <p>
          <a href="tel:+74951297535" class="underline hover:text-blue-600" target="_blank" rel="noopener noreferrer">+7 (495) 129-75-35</a>
        </p>
      </div>
    </div>
  
<!-- Кнопка "Заказать звонок" -->
<div class="w-full text-center">
  <a id="callOrderBtn"
     href="#"
     class="mt-2 block text-center bg-[#2511A8] text-white text-base font-semibold py-2 w-full">
    Заказать звонок
  </a>
</div>

<!-- Модальное окно -->
<div id="modalOverlay" class="fixed top-0 left-0 w-full h-[140px] bg-black bg-opacity-50 z-50 hidden">
  <div class="bg-[#E2E2E2] w-full h-full px-4 pt-2 box-border">
    <h2 class="text-sm font-semibold mb-1">Введите номер телефона</h2>
    <div class="flex items-center space-x-2 mb-1">
      <span class="text-lg font-bold">+7</span>
      <input type="tel" id="userPhone" class="w-full px-2 py-1 border text-sm" placeholder="999-222-55-77">
    </div>
    <div class="flex items-center mb-1">
      <input type="checkbox" id="savePhone" class="mr-2">
      <span class="text-sm">Сохранить номер</span>
    </div>
    <div class="flex justify-between space-x-2">
      <button id="cancelBtn" class="bg-[#2511A8] text-white px-4 py-1 w-1/2 text-sm rounded-none">Отменить</button>
      <button id="submitBtn" class="bg-[#2511A8] text-white px-4 py-1 w-1/2 text-sm rounded-none" disabled>Отправить</button>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const supabase = createClient(
    "https://yiprwrgmyqlkdmhgulmc.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpcHJ3cmdteXFsa2RtaGd1bG1jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ2NTI0NjgsImV4cCI6MjA2MDIyODQ2OH0.lfiTfr5ukGDEVuwq-X9U2kWs3nEZrp3N443HT5AkbfI"
  );

  const callOrderBtn = document.getElementById("callOrderBtn");
  const modalOverlay = document.getElementById("modalOverlay");
  const cancelBtn = document.getElementById("cancelBtn");
  const submitBtn = document.getElementById("submitBtn");
  const userPhoneInput = document.getElementById("userPhone");

  async function checkAndSend() {
    const tg = window.Telegram.WebApp;
    const telegram_id = tg.initDataUnsafe?.user?.id;

    if (!telegram_id) return;

    const { data, error } = await supabase
      .from("users")
      .select("nomber_tel")
      .eq("telegram_id", telegram_id)
      .single();

    if (error && error.code !== 'PGRST116') {
      console.error("Supabase error:", error);
      return;
    }

    if (data && data.nomber_tel) {
      const encoded = encodeURIComponent(`POZVONI_MNE_${data.nomber_tel}`);
      tg.openTelegramLink(`https://t.me/WAYMORR_BOT?start=${encoded}`);
    } else {
      modalOverlay.classList.remove("hidden");
      userPhoneInput.focus();
    }
  }

  callOrderBtn.addEventListener("click", (e) => {
    e.preventDefault();
    checkAndSend();
  });

  cancelBtn.addEventListener("click", () => {
    modalOverlay.classList.add("hidden");
  });

  submitBtn.addEventListener("click", async () => {
    let phone = userPhoneInput.value.trim().replace(/[^0-9]/g, "");
    if (phone.startsWith("7")) phone = phone.slice(1);
    const fullPhone = `+7${phone}`;

    if (!/^[0-9]{10}$/.test(phone)) {
      alert("Введите корректный номер телефона");
      return;
    }

    const tg = window.Telegram.WebApp;
    const telegram_id = tg.initDataUnsafe?.user?.id;
    if (!telegram_id) return;

    if (document.getElementById("savePhone").checked) {
      const { data: existing, error: selectError } = await supabase
        .from("users")
        .select("id")
        .eq("telegram_id", telegram_id)
        .single();

      if (selectError && selectError.code !== 'PGRST116') {
        console.error("Ошибка при проверке пользователя:", selectError);
      } else if (existing) {
        // Обновляем номер телефона, если пользователь уже есть
        const { error: updateError } = await supabase
          .from("users")
          .update({ nomber_tel: fullPhone })
          .eq("telegram_id", telegram_id);
        if (updateError) console.error("Ошибка при обновлении:", updateError);
      } else {
        // Вставляем нового пользователя, если его ещё нет в базе
        const { error: insertError } = await supabase
          .from("users")
          .insert([{ telegram_id, nomber_tel: fullPhone }]);
        if (insertError) console.error("Ошибка при вставке:", insertError);
      }
    }

    const encoded = encodeURIComponent(`POZVONI_MNE_${fullPhone}`);
    tg.openTelegramLink(`https://t.me/WAYMORR_BOT?start=${encoded}`);
  });

  userPhoneInput.addEventListener("input", (e) => {
    const digits = e.target.value.replace(/\D/g, "").slice(0, 10);
    let formatted = digits;
    if (digits.length > 6) {
      formatted = `${digits.slice(0, 3)}-${digits.slice(3, 6)}-${digits.slice(6, 8)}-${digits.slice(8, 10)}`;
    } else if (digits.length > 3) {
      formatted = `${digits.slice(0, 3)}-${digits.slice(3, 6)}`;
    }
    e.target.value = formatted;
    submitBtn.disabled = digits.length !== 10;
  });

  window.addEventListener("DOMContentLoaded", () => {
    if (window.location.hash === "#call") {
      callOrderBtn.click();
    }
  });
</script>



</script>

  
  
  <script>
    function openMap(url) {
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.openLink(url);
      } else {
        window.open(url, '_blank');
      }
    }
  </script>
</body>
</html>


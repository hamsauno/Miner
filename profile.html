<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Профиль</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-[#1e1e1e] text-white font-sans min-h-screen flex items-center justify-center px-4">

  <div class="w-full max-w-md bg-[#2a2a2a] rounded-2xl shadow-xl p-6 space-y-4">
    <h2 class="text-2xl font-bold text-center text-white">Ваш профиль</h2>

    <div class="space-y-2">
      <label class="block text-sm text-gray-400">Имя</label>
      <input id="name" type="text" class="w-full px-3 py-2 bg-[#3a3a3a] rounded-lg text-white outline-none" />
    </div>

    <div class="space-y-2">
      <label class="block text-sm text-gray-400">Email</label>
      <input id="email" type="email" class="w-full px-3 py-2 bg-[#3a3a3a] rounded-lg text-white outline-none" />
    </div>

    <div class="space-y-2">
      <label class="block text-sm text-gray-400">Город</label>
      <input id="city" type="text" class="w-full px-3 py-2 bg-[#3a3a3a] rounded-lg text-white outline-none" />
    </div>

    <div class="text-sm text-gray-500 pt-2">
      <p><b>Telegram ID:</b> <span id="telegram_id"></span></p>
      <p><b>Username:</b> <span id="telegram_username"></span></p>
    </div>

    <p id="status" class="text-center text-sm text-green-400 mt-4 hidden">Сохранено</p>
  </div>

  <script>
    const { createClient } = supabase;
    const supabaseUrl = "https://yiprwrgmyqlkdmhgulmc.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
    const supabaseClient = createClient(supabaseUrl, supabaseKey);

    const tg = window.Telegram.WebApp;
    tg.ready();

    const telegramId = tg?.initDataUnsafe?.user?.id;
    const telegramUsername = tg?.initDataUnsafe?.user?.username || "—";

    const nameInput = document.getElementById("name");
    const emailInput = document.getElementById("email");
    const cityInput = document.getElementById("city");
    const statusText = document.getElementById("status");

    document.getElementById("telegram_id").textContent = telegramId || "—";
    document.getElementById("telegram_username").textContent = telegramUsername;

    async function loadProfile() {
      const { data, error } = await supabaseClient
        .from("users")
        .select("*")
        .eq("telegram_id", telegramId.toString())
        .single();

      if (data) {
        nameInput.value = data.name || "";
        emailInput.value = data.email || "";
        cityInput.value = data.city || "";
      } else {
        alert("Пользователь не найден");
      }
    }

    let debounceTimer;
    function autoSave() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(async () => {
        await supabaseClient
          .from("users")
          .update({
            name: nameInput.value.trim(),
            email: emailInput.value.trim(),
            city: cityInput.value.trim()
          })
          .eq("telegram_id", telegramId.toString());

        statusText.classList.remove("hidden");
        setTimeout(() => statusText.classList.add("hidden"), 1500);
      }, 1000);
    }

    [nameInput, emailInput, cityInput].forEach(input => {
      input.addEventListener("input", autoSave);
    });

    loadProfile();
  </script>

</body>
</html>

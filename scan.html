<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ü–æ–∏—Å–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ —Å–µ—Ç–∏</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #f4f4f4; }
    h1 { margin-bottom: 1rem; }
    .filters button {
      margin-right: 10px;
      padding: 8px 12px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background-color: #ddd;
    }
    .filters button.active {
      background-color: #4caf50;
      color: white;
    }
    .device-list { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem; }
    .device-card {
      background: white;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      width: 250px;
    }
    .device-card h3 {
      margin-top: 0;
    }
  </style>
</head>
<body>
  <h1>–ü–æ–∏—Å–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ —Å–µ—Ç–∏</h1>
  <div class="filters">
    <button onclick="filterDevices('all')" class="active">–í—Å–µ</button>
    <button onclick="filterDevices('asic')">ASIC</button>
    <button onclick="filterDevices('server')">–°–µ—Ä–≤–µ—Ä</button>
    <button onclick="filterDevices('other')">–ü—Ä–æ—á–µ–µ</button>
  </div>
  <div id="status">üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...</div>
  <div class="device-list" id="devices"></div>

  <script>
    let allDevices = [];

    async function scanMultipleNetworks(subnets = ['192.168.0.', '192.168.1.', '10.0.0.'], port = 8080) {
      const allResults = [];

      for (const base of subnets) {
        document.getElementById("status").textContent = `üì° –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ${base}...`;
        const result = await scanSubnet(base, port);
        allResults.push(...result);
      }

      return allResults;
    }

    async function scanSubnet(base, port) {
      const foundDevices = [];
      const requests = [];

      for (let i = 1; i <= 254; i++) {
        const ip = `${base}${i}`;
        const url = `http://${ip}:${port}/identify`;

        const req = fetch(url, { method: 'GET' })
          .then(async res => {
            const json = await res.json();
            foundDevices.push({
              type: json.type || 'other',
              model: json.model || json.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ',
              ip
            });
          })
          .catch(() => {}); // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏

        requests.push(req);
      }

      await Promise.allSettled(requests);
      return foundDevices;
    }

    function renderDevices(devices) {
      const container = document.getElementById("devices");
      container.innerHTML = "";

      devices.forEach(device => {
        const el = document.createElement("div");
        el.className = "device-card";
        el.innerHTML = `
          <h3>${device.model}</h3>
          <p><strong>–¢–∏–ø:</strong> ${device.type.toUpperCase()}</p>
          <p><strong>IP:</strong> ${device.ip}</p>
          <button onclick="connectToDevice('${device.ip}')">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        `;
        container.appendChild(el);
      });

      document.getElementById("status").textContent = `‚úÖ –ù–∞–π–¥–µ–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤: ${devices.length}`;
    }

    function filterDevices(type) {
      document.querySelectorAll(".filters button").forEach(btn => btn.classList.remove("active"));
      document.querySelector(`.filters button[onclick*="${type}"]`).classList.add("active");

      if (type === "all") {
        renderDevices(allDevices);
      } else {
        renderDevices(allDevices.filter(d => d.type === type));
      }
    }

    function connectToDevice(ip) {
      const url = `http://${ip}:8080/info`;
      fetch(url)
        .then(res => res.json())
        .then(data => {
          alert(`–î–∞–Ω–Ω—ã–µ —Å ${ip}:\n${JSON.stringify(data, null, 2)}`);
        })
        .catch(() => alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ ${ip}`));
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    (async () => {
      allDevices = await scanMultipleNetworks(['192.168.0.', '192.168.1.', '10.0.0.']);
      renderDevices(allDevices);
    })();
  </script>
</body>
</html>

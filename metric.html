<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .accordion-content.open {
      max-height: 1000px; /* –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–æ–ª—å—à–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ */
    }

    .swipe-panel {
      position: absolute;
      top: 0;
      right: -100%;
      width: 80%;
      max-width: 300px;
      height: 100%;
      background-color: #f8fafc;
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
      padding: 15px;
      overflow-y: auto;
      transition: right 0.3s ease-in-out;
      z-index: 20;
      border-left: 2px solid #ddd;
    }
  </style>
</head>
<body class="bg-[#E2E2E2] text-black min-h-screen p-6 overflow-x-hidden">

  <div class="flex space-x-6 overflow-x-auto scroll-snap-x">
    
    <!--  –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
    <section class="min-w-full snap-start">
      <h2 class="text-xl font-semibold mb-2"> –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
      <div id="userList" class="space-y-2 text-sm">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      <!-- –î–æ–±–∞–≤—å —ç—Ç–æ –≤ <body>, —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ <div id="userList"> -->
      <div id="swipePanel" class="swipe-panel fixed top-0 right-[-100%] bg-white z-50 transition-all duration-300">
        <h2 class="text-lg font-semibold mb-4">üìä –î–µ—Ç–∞–ª–∏</h2>
        <p>–ó–¥–µ—Å—å –º–æ–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.</p>
      </div>
    </section>


  </div>

  <!-- –°–∫—Ä–∏–ø—Ç -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const supabaseUrl = 'https://yiprwrgmyqlkdmhgulmc.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpcHJ3cmdteXFsa2RtaGd1bG1jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ2NTI0NjgsImV4cCI6MjA2MDIyODQ2OH0.lfiTfr5ukGDEVuwq-X9U2kWs3nEZrp3N443HT5AkbfI'; // —Ç–æ—Ç –∂–µ –∫–ª—é—á
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
      const userList = document.getElementById('userList');
      const swipePanel = document.getElementById('swipePanel');
  
      const { data, error } = await supabase
        .from('visits')
        .select('*')
        .order('timestamp', { ascending: true });
  
      if (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –¥–∞–Ω–Ω—ã—Ö:", error);
        return;
      }
  
      userList.innerHTML = '';
      const usersByMonth = {};
  
      data.forEach(visit => {
        const dateObj = new Date(visit.timestamp);
        const date = dateObj.toISOString().split('T')[0];
        const monthKey = dateObj.toLocaleString('default', { year: 'numeric', month: 'long' });
        const monthDate = dateObj.toISOString().slice(0, 7);
  
        if (!usersByMonth[monthKey]) {
          usersByMonth[monthKey] = { days: {}, allVisits: 0, uniqueUsers: new Set(), monthDate };
        }
  
        usersByMonth[monthKey].allVisits++;
        usersByMonth[monthKey].uniqueUsers.add(visit.telegram_id);
  
        if (!usersByMonth[monthKey].days[date]) {
          usersByMonth[monthKey].days[date] = new Map();
        }
  
        const userMap = usersByMonth[monthKey].days[date];
        const id = visit.telegram_id;
  
        if (!userMap.has(id)) {
          userMap.set(id, {
            username: visit.username,
            telegram_id: id,
            visitCount: 1
          });
        } else {
          userMap.get(id).visitCount++;
        }
      });
  
      const sortedMonths = Object.entries(usersByMonth).sort((a, b) => {
        return b[1].monthDate.localeCompare(a[1].monthDate);
      });
  
      let openMonthBlock = null;
  
      sortedMonths.forEach(([month, monthData]) => {
        const monthBlock = document.createElement('div');
        monthBlock.className = "mb-3 border rounded bg-white shadow";
  
        const monthHeader = document.createElement('div');
        monthHeader.className = "cursor-pointer p-3 font-semibold text-lg bg-gray-100";
        monthHeader.textContent = `${month} - ${monthData.allVisits} IN (${monthData.uniqueUsers.size} —É–Ω–∏–∫.)`;
        monthBlock.appendChild(monthHeader);
  
        const monthContent = document.createElement('div');
        monthContent.className = "accordion-content px-4 pt-2 pb-3 bg-white";
        monthBlock.appendChild(monthContent);
  
        monthHeader.addEventListener('click', () => {
          if (openMonthBlock && openMonthBlock !== monthContent) {
            openMonthBlock.classList.remove('open');
          }
          const isOpen = monthContent.classList.toggle('open');
          openMonthBlock = isOpen ? monthContent : null;
        });
  
        let openDayBlock = null;
  
        const sortedDays = Object.entries(monthData.days).sort((a, b) => b[0].localeCompare(a[0])); // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–±—ã–≤–∞–Ω–∏—é
  
        sortedDays.forEach(([date, userMap]) => {
          const dayBlock = document.createElement('div');
          dayBlock.className = "mb-2";
  
          const dayHeader = document.createElement('div');
          dayHeader.className = "cursor-pointer font-medium bg-gray-200 px-3 py-1 rounded";
          dayHeader.textContent = `${date} ‚Äî ${userMap.size} —É–Ω–∏–∫.users`;
          dayBlock.appendChild(dayHeader);
  
          const dayContent = document.createElement('div');
          dayContent.className = "accordion-content ml-4 mt-1 mb-2";
  
          const ul = document.createElement('ul');
          ul.className = "list-disc list-inside space-y-1 text-sm";
  
          userMap.forEach(user => {
            const li = document.createElement('li');
            const username = user.username ? user.username : 'unknown';
            const profileLink = user.username
              ? `<a href="https://t.me/${username}" target="_blank" class="text-blue-600 hover:underline">@${username}</a>`
              : `@${username}`;
            li.innerHTML = `${profileLink} (${user.telegram_id}) ‚Äî ${user.visitCount} IN`;
            ul.appendChild(li);
          });
  
          dayContent.appendChild(ul);
          dayBlock.appendChild(dayContent);
          monthContent.appendChild(dayBlock);
  
          dayHeader.addEventListener('click', () => {
            if (openDayBlock && openDayBlock !== dayContent) {
              openDayBlock.classList.remove('open');
            }
            const isOpen = dayContent.classList.toggle('open');
            openDayBlock = isOpen ? dayContent : null;
          });
        });
  
        userList.appendChild(monthBlock);
      });
  
      // --- –°–≤–∞–π–ø –≤–ª–µ–≤–æ –Ω–∞ –±–ª–æ–∫–µ —Å–µ–∫—Ü–∏–∏ ---
      let touchStartX = 0;
      let touchEndX = 0;
  
      userList.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
      });
  
      userList.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipeGesture();
      });
  
      function handleSwipeGesture() {
        const threshold = 80;
        if (touchStartX - touchEndX > threshold) {
          swipePanel.style.right = '0';
        } else if (touchEndX - touchStartX > threshold) {
          swipePanel.style.right = '-100%';
        }
      }
    });
  </script>
  

</body>
</html>

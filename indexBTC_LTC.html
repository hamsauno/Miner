<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ –º–∞–π–Ω–∏–Ω–≥–∞</title>
<meta name="description" content="–£–¥–æ–±–Ω—ã–π Telegram-–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ ASIC-–º–∞–π–Ω–µ—Ä–æ–≤. –î–æ—Ö–æ–¥, –ø—Ä–∏–±—ã–ª—å, ROI, –æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å ‚Äî –≤—Å—ë –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ.">
<style>
  /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
  html, body {
    overscroll-behavior-y: none;
    touch-action: pan-y;
  }

  /* –£–±–∏—Ä–∞–µ–º –∂–∏—Ä–Ω–æ—Å—Ç—å –∏ –æ–±–≤–æ–¥–∫—É —É –≤—ã–¥–µ–ª–µ–Ω–∏—è */
  .tutorial-highlight {
    box-shadow: none !important;
    font-weight: normal !important;
    text-shadow: none !important;
    position: relative;
    z-index: 10001; /* –ù–∞–¥ –æ–≤–µ—Ä–ª–µ–µ–º */
  }

  /* –ó–∞—Ç–µ–º–Ω—è—é—â–∏–π –æ–≤–µ—Ä–ª–µ–π —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–π –¥—ã—Ä–∫–æ–π */
  .tutorial-modal-overlay {
    display: none;
    position: fixed;
    z-index: 10000; /* –ù–∏–∂–µ, —á–µ–º .tutorial-highlight */
    left: 0;
    top: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.8);
    pointer-events: none; /* –ß—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å –∫–ª–∏–∫–∞–º –ø–æ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π –∑–æ–Ω–µ */
  }

  /* –ü—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º –æ–±—É—á–µ–Ω–∏–∏ - –∑–∞—Ç–µ–º–Ω—è–µ–º –∏ –±–ª–æ–∫–∏—Ä—É–µ–º –≤—Å—ë –∫—Ä–æ–º–µ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ */
  body.tutorial-active > *:not(.tutorial-modal-overlay):not(.tutorial-highlight) {
    pointer-events: none;
    user-select: none;
    opacity: 0.3;
  }

  /* –†–∞–∑—Ä–µ—à–∞–µ–º –∫–ª–∏–∫–∏ –∏ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ */
  body.tutorial-active .tutorial-highlight,
  body.tutorial-active .tutorial-highlight * {
    pointer-events: auto !important;
    user-select: text !important;
    opacity: 1 !important;
  }
</style>

<script>
  function updateOverlayMask() {
    const highlight = document.querySelector('.tutorial-highlight');
    const overlay = document.querySelector('.tutorial-modal-overlay');
    if (!highlight || !overlay) return;

    const rect = highlight.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    const radius = Math.max(rect.width, rect.height) / 2 + 10; // +10px –æ—Ç—Å—Ç—É–ø –≤–æ–∫—Ä—É–≥

    // –°–æ–∑–¥–∞—ë–º CSS –º–∞—Å–∫—É —Å –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º –∫—Ä—É–≥–æ–º –ø–æ —Ü–µ–Ω—Ç—Ä—É –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
    const maskValue = `radial-gradient(circle at ${centerX}px ${centerY}px, transparent ${radius}px, black ${radius + 1}px)`;

    overlay.style.maskImage = maskValue;
    overlay.style.webkitMaskImage = maskValue;

    overlay.style.display = 'block';
  }

  // –ó–∞–ø—É—Å–∫ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –æ–±—É—á–µ–Ω–∏—è
  function startTutorial() {
    document.body.classList.add('tutorial-active');
    updateOverlayMask();
  }

  // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—É—á–µ–Ω–∏—è
  function stopTutorial() {
    document.body.classList.remove('tutorial-active');
    const overlay = document.querySelector('.tutorial-modal-overlay');
    if (overlay) overlay.style.display = 'none';
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ
  window.addEventListener('resize', () => {
    if (document.body.classList.contains('tutorial-active')) {
      updateOverlayMask();
    }
  });

  // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Å—Ä–∞–∑—É –∑–∞–ø—É—Å—Ç–∏–º –æ–±—É—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 1 —Å–µ–∫
  window.addEventListener('DOMContentLoaded', () => {
    setTimeout(startTutorial, 1000);
  });
</script>

<!-- –ó–∞—Ç–µ–º–Ω—è—é—â–∏–π –æ–≤–µ—Ä–ª–µ–π -->
<div class="tutorial-modal-overlay"></div>

<!-- –ü—Ä–∏–º–µ—Ä –≤—ã–¥–µ–ª—è–µ–º–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ -->
<div style="margin: 100px; padding: 20px; background: #eee;">
  <p>–ù–æ—Ä–º–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç</p>
  <button class="tutorial-highlight" style="padding: 10px 20px; background: #2511A8; color: white; border:none;">
    –≠–ª–µ–º–µ–Ω—Ç –≤—ã–¥–µ–ª–µ–Ω–∏—è –¥–ª—è –æ–±—É—á–µ–Ω–∏—è
  </button>
  <p>–ï—â—ë —Ç–µ–∫—Å—Ç</p>
</div>

</head>
<body class="bg-black">
    <div id="headerSection" class="w-full bg-[#000000] text-white shadow-xl p-5 mb-[3px]">
      <div class="form-content space-y-2">
         <div class="flex gap-3">
           <div class="w-1/2">
             <label for="algorithmSelect" class="block text-sm font-medium mb-1">–ê–ª–≥–æ—Ä–∏—Ç–º</label>
             <select id="algorithmSelect"
               class="bg-[#E2E2E2] w-full px-2 py-1 border border-gray-400 text-black text-sm focus:outline-none focus:ring-2 focus:ring-yellow-400">
               <option value="SHA-256">SHA-256</option>
               <option value="Scrypt">SCRYPT</option>
             </select>
           </div>
           <div class="w-1/2">
             <label for="manufacturerSelect" class="block text-sm font-medium mb-1">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</label>
             <select id="manufacturerSelect"
               class="bg-[#E2E2E2] w-full px-2 py-1 border border-gray-400 text-black text-sm focus:outline-none focus:ring-2 focus:ring-yellow-400">
               </select>
           </div>
         </div>

         <div>
           <label for="asicModel" class="block text-sm font-medium mb-1">–ú–æ–¥–µ–ª—å –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</label>
           <select id="asicModel"
             class="bg-[#E2E2E2] w-full px-2 py-1 border border-gray-400 text-black text-sm focus:outline-none focus:ring-2 focus:ring-yellow-400">
             </select>
         </div>

         <div class="flex gap-3">
           <div class="w-1/2">
             <label class="block text-sm font-medium mb-1">–•—ç—à—Ä–µ–π—Ç</label>
             <div id="hashrateContainer"> <span id="hashrate"></span><span id="edprice"></span>
             </div>
           </div>
           <div class="w-1/2">
             <label class="block text-sm font-medium mb-1">–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ</label>
             <div id="powerContainer"> <span id="power"></span><span id="power_unit"></span>
             </div>
           </div>
         </div>

         <div class="flex gap-3">
           <div class="w-1/2">
             <label for="electricityCost" class="block text-sm font-medium mb-1">–°—Ç–æ–∏–º–æ—Å—Ç—å <br> –≠–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏</label>
             <div class="relative">
               <input
                 type="number"
                 id="electricityCost"
                 value="5"
                 inputmode="decimal"
                 step="any"
                 class="bg-[#E2E2E2] w-full px-2 py-1 pr-6 border border-gray-400 text-black text-sm focus:outline-none focus:ring-2 focus:ring-yellow-400">
               <span class="absolute right-2 top-1/2 -translate-y-1/2 text-black text-xs">‚ÇΩ</span>
             </div>
           </div>
           <div class="w-1/2">
             <label for="asicCost" class="block text-sm font-medium mb-1">–°—Ç–æ–∏–º–æ—Å—Ç—å <br> –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</label>
             <div class="relative">
               <input type="number" id="asicCost" inputmode="numeric"
                 class="bg-[#E2E2E2] w-full px-2 py-1 pr-6 border border-gray-400 text-black text-sm focus:outline-none focus:ring-2 focus:ring-yellow-400"
                 placeholder="–ê–≤—Ç–æ/–†—É—á–Ω–æ–π –≤–≤–æ–¥"> <span class="absolute right-2 top-1/2 -translate-y-1/2 text-black text-xs">‚ÇΩ</span>
             </div>
           </div>
         </div>

         <input type="hidden" id="btcPrice">
         <input type="hidden" id="usdtPrice">
         <input type="hidden" id="profitPerTH">
         <input type="hidden" id="ltcPrice">
         <input type="hidden" id="dogePrice">
         <input type="hidden" id="bellPrice">
         <input type="hidden" id="profitPerLTC">
         <input type="hidden" id="profitPerDOGE">
         <input type="hidden" id="profitPerBELL">
      </div>
      <div class="button-container pt-2">
        <button id="calculateBtn"
          class="w-full text-white font-bold text-base py-2 px-4 transition duration-300 hover:brightness-110 shadow-md"
          style="background-color: #2511A8;">
          –†–∞—Å—Å—á–∏—Ç–∞—Ç—å
        </button>
        <div id="notification" class="mt-2 p-2 text-center text-white bg-black hidden">
          –†–∞—Å—á—ë—Ç –ø—Ä–æ–∏–∑–≤–µ–¥—ë–Ω
        </div>
      </div>
   </div>

   <div id="resultsContainer" class="w-full bg-[#E2E2E2] text-sm space-y-4 shadow-md px-4 pb-4 pt-4">
     <div>
       <div id="progressBarContainer" class="w-full h-5 relative overflow-hidden border" style="border-color: #2511A8;">
         <div id="dailyProfitBar" class="absolute top-0 left-0 h-full transition-all duration-500" style="background-color: #2511A8;"></div>
         <div id="dailyElectricityCostBar" class="absolute top-0 h-full transition-all duration-500" style="background-color: #CCCCCC;"></div>
       </div>
       <div class="mt-1 text-xs text-black flex justify-between">
         <div id="profitPercentageLabel">–ü—Ä–∏–±—ã–ª—å: --%</div>
         <div id="costPercentageLabel">–ó–∞—Ç—Ä–∞—Ç—ã: --%</div>
       </div>
     </div>

     <div class="scroll-container w-full overflow-x-auto">
       <table id="resultsTable" class="result-table w-full text-sm text-center border-collapse">
         <thead>
           <tr>
             <th class="bg-black text-white p-0 w-24 align-middle">
               <div id="currencyButtonsContainer" class="flex justify-center items-center h-full">
                 <button id="currencyUSD" class="currency-btn w-7 h-7 active">$</button>
                 <button id="currencyRUB" class="currency-btn w-7 h-7 inactive">‚ÇΩ</button>
               </div>
             </th>
             <th class="bg-black text-white p-2">–î–µ–Ω—å</th>
             <th class="bg-black text-white p-2">–ú–µ—Å—è—Ü</th>
             <th class="bg-black text-white p-2">–ì–æ–¥</th>
           </tr>
         </thead>
         <tbody>
           <tr>
             <td class="bg-black text-white p-2 w-24">–î–æ—Ö–æ–¥</td>
             <td class="bg-[#E2E2E2] text-black p-2">
               <span class="text-[#2511A8] font-semibold" id="income">$ --.--</span>
               <span class="text-[#2511A8] font-semibold hidden" id="income_rub">-- ‚ÇΩ</span>
             </td>
             <td class="bg-[#E2E2E2] text-black p-2">
               <span class="text-[#2511A8] font-semibold" id="incomeMonth">$ --.--</span>
               <span class="text-[#2511A8] font-semibold hidden" id="incomeMonth_rub">-- ‚ÇΩ</span>
             </td>
             <td class="bg-[#E2E2E2] text-black p-2">
               <span class="text-[#2511A8] font-semibold" id="incomeYear">$ --.--</span>
               <span class="text-[#2511A8] font-semibold hidden" id="incomeYear_rub">-- ‚ÇΩ</span>
             </td>
           </tr>
           <tr>
             <td class="bg-black text-white p-2 w-24">–ü—Ä–∏–±—ã–ª—å</td>
             <td class="bg-[#E2E2E2] text-black p-2">
               <span class="text-[#2511A8] font-semibold" id="profit">$ --.--</span>
               <span class="text-[#2511A8] font-semibold hidden" id="profit_rub">-- ‚ÇΩ</span>
             </td>
             <td class="bg-[#E2E2E2] text-black p-2">
               <span class="text-[#2511A8] font-semibold" id="profitMonth">$ --.--</span>
               <span class="text-[#2511A8] font-semibold hidden" id="profitMonth_rub">-- ‚ÇΩ</span>
             </td>
             <td class="bg-[#E2E2E2] text-black p-2">
               <span class="text-[#2511A8] font-semibold" id="profitYear">$ --.--</span>
               <span class="text-[#2511A8] font-semibold hidden" id="profitYear_rub">-- ‚ÇΩ</span>
             </td>
           </tr>
         </tbody>
       </table>
     </div>
     <div id="paybackRoiContainer" class="mt-4 text-black flex justify-between">
        <div id="paybackLabelContainer">–û–∫—É–ø–∞–µ–º–æ—Å—Ç—å –º–µ—Å.: <span id="payback">‚Äî</span></div>
        <div id="roiLabelContainer">–ì–æ–¥–æ–≤–æ–π %: <span id="roi">‚Äî</span></div>
      </div>
   </div>

   <div id="tutorialModalOverlay" class="tutorial-modal-overlay"></div>
   <div id="tutorialModal" class="tutorial-modal">
       <h3 id="tutorialTitle">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h3>
       <p id="tutorialText">–≠—Ç–æ –∫—Ä–∞—Ç–∫–æ–µ –æ–±—É—á–µ–Ω–∏–µ –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –æ—Å–≤–æ–∏—Ç—å—Å—è —Å –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–æ–º.</p>
       <button id="tutorialNextBtn" class="tutorial-modal-next-btn">–î–∞–ª–µ–µ</button>
       <button id="tutorialSkipBtn" class="tutorial-modal-skip-btn">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
   </div>

<script>
// --- –ù–ê–ß–ê–õ–û –ë–õ–û–ö–ê –û–ë–£–ß–ï–ù–ò–Ø ---

const SUPABASE_URL = 'https://yiprwrgmyqlkdmhgulmc.supabase.co'; // –í–∞—à URL Supabase
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpcHJ3cmdteXFsa2RtaGd1bG1jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ2NTI0NjgsImV4cCI6MjA2MDIyODQ2OH0.lfiTfr5ukGDEVuwq-X9U2kWs3nEZrp3N443HT5AkbfI'; // –í–∞—à ANON KEY

let supabaseClient;
try {
  supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
} catch (e) {
  console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Supabase:", e);
}

let currentTutorialStep = 0;
let tutorialSteps = [];
let telegramUser = null;

const tutorialModalOverlay = document.getElementById('tutorialModalOverlay');
const tutorialModal = document.getElementById('tutorialModal');
const tutorialTitle = document.getElementById('tutorialTitle');
const tutorialText = document.getElementById('tutorialText');
const tutorialNextBtn = document.getElementById('tutorialNextBtn');
const tutorialSkipBtn = document.getElementById('tutorialSkipBtn');

let highlightedElement = null;
let highlightedAncestors = [];

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –∑–∞–ø—É—Å–∫–∞ –æ–±—É—á–µ–Ω–∏—è
async function initAppAndTutorial() {
  console.log("DOM –∑–∞–≥—Ä—É–∂–µ–Ω");
  Telegram.WebApp.ready();
  console.log("Telegram WebApp –≥–æ—Ç–æ–≤");

  try {
    await fetchData();
    await onAlgorithmChange();
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:", error);
  }

  if (Telegram.WebApp.initDataUnsafe?.user) {
    telegramUser = Telegram.WebApp.initDataUnsafe.user;
    if (telegramUser.id) {
      console.log("Telegram User ID:", telegramUser.id);
      await checkTutorialStatus();
    } else {
      console.warn("Telegram User ID –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±—É—á–µ–Ω–∏–µ –Ω–µ –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω–æ.");
    }
  } else {
    console.warn("–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram WebApp –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç. –û–±—É—á–µ–Ω–∏–µ –Ω–µ –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω–æ.");
  }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ–±—É—á–µ–Ω–∏—è –≤ –±–∞–∑–µ
async function checkTutorialStatus() {
  if (!supabaseClient || !telegramUser?.id) {
    console.error("Supabase –∏–ª–∏ Telegram User –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã. –û–±—É—á–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ.");
    return;
  }

  console.log("–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ–±—É—á–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", telegramUser.id);

  try {
    const { data: user, error } = await supabaseClient
      .from('users')
      .select('telegram_id, tutor')
      .eq('telegram_id', telegramUser.id.toString())
      .single();

    if (error && error.code !== 'PGRST116') {
      console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
      return;
    }

    if (user?.tutor === true) {
      console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –ø—Ä–æ—à–µ–ª –æ–±—É—á–µ–Ω–∏–µ.");
    } else {
      console.log(user ? "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—Ä–æ—à–µ–ª –æ–±—É—á–µ–Ω–∏–µ (tutor=false), –∑–∞–ø—É—Å–∫–∞–µ–º." : "–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –∑–∞–ø—É—Å–∫–∞–µ–º –æ–±—É—á–µ–Ω–∏–µ.");
      setupTutorialSteps();
      startTutorial();
    }
  } catch (e) {
    console.error("–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ –æ–±—É—á–µ–Ω–∏—è:", e);
  }
}

// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —à–∞–≥–æ–≤ –æ–±—É—á–µ–Ω–∏—è
function setupTutorialSteps() {
  tutorialSteps = [
    { text: "–í—ã–±–µ—Ä–∏—Ç–µ –ê–ª–≥–æ—Ä–∏—Ç–º: SHA-256 (BTC) –∏–ª–∏ Scrypt (LTC, DOGE).", elementId: "algorithmSelect" },
    { text: "–í—ã–±–µ—Ä–∏—Ç–µ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è ASIC-–º–∞–π–Ω–µ—Ä–∞ –∏–∑ —Å–ø–∏—Å–∫–∞.", elementId: "manufacturerSelect" },
    { text: "–í—ã–±–µ—Ä–∏—Ç–µ –ú–æ–¥–µ–ª—å –≤–∞—à–µ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.", elementId: "asicModel" },
    { text: "–£–∫–∞–∂–∏—Ç–µ –°—Ç–æ–∏–º–æ—Å—Ç—å –≠–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏ –∑–∞ 1 –∫–í—Ç/—á.", elementId: "electricityCost" },
    { text: "–°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –Ω–æ –≤—ã –º–æ–∂–µ—Ç–µ —É–∫–∞–∑–∞—Ç—å —Å–≤–æ—é —Ü–µ–Ω—É.", elementId: "asicCost" },
    { text: "–ù–∞–∂–º–∏—Ç–µ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏.", elementId: "calculateBtn" },
    { text: "–ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –ü—Ä–∏–±—ã–ª–∏ –∏ –ó–∞—Ç—Ä–∞—Ç –Ω–∞ —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—é.", elementId: "progressBarContainer" },
    { text: "–ü—Ä–æ—Ü–µ–Ω—Ç –¥–Ω–µ–≤–Ω–æ–π –ü—Ä–∏–±—ã–ª–∏ –ø–æ—Å–ª–µ –≤—ã—á–µ—Ç–∞ –∑–∞—Ç—Ä–∞—Ç.", elementId: "profitPercentageLabel" },
    { text: "–ü—Ä–æ—Ü–µ–Ω—Ç –¥–Ω–µ–≤–Ω—ã—Ö –ó–∞—Ç—Ä–∞—Ç –Ω–∞ —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—é.", elementId: "costPercentageLabel" },
    { text: "–í —Ç–∞–±–ª–∏—Ü–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å –≤–∞–ª—é—Ç—É –º–µ–∂–¥—É $ –∏ ‚ÇΩ.", elementId: "resultsTable" },
    { text: "–ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–π —Å—Ä–æ–∫ –û–∫—É–ø–∞–µ–º–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –≤ –º–µ—Å—è—Ü–∞—Ö.", elementId: "paybackLabelContainer" },
    { text: "–ì–æ–¥–æ–≤–æ–π ROI ‚Äî –ø—Ä–∏–±—ã–ª—å –∑–∞ –≥–æ–¥ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.", elementId: "roiLabelContainer" },
    { title: "–û–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!", text: "–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –¢–µ–ø–µ—Ä—å –≤—ã –∑–Ω–∞–µ—Ç–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞.", elementId: null }
  ];
}

// –ó–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è
function startTutorial() {
  currentTutorialStep = 0;
  tutorialModalOverlay.style.display = 'block';
  tutorialModal.style.display = 'block';
  document.body.classList.add('tutorial-active');
  Telegram.WebApp.expand();
  showTutorialStep();
}

// –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∏
function removeHighlight() {
  if (highlightedElement) {
    highlightedElement.classList.remove('tutorial-highlight');
    highlightedElement = null;
  }
  highlightedAncestors.forEach(el => el.classList.remove('tutorial-highlighted-ancestor'));
  highlightedAncestors = [];
  document.querySelectorAll('.tutorial-highlight').forEach(el => el.classList.remove('tutorial-highlight'));
  document.querySelectorAll('.tutorial-highlighted-ancestor').forEach(el => el.classList.remove('tutorial-highlighted-ancestor'));
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞ –æ–±—É—á–µ–Ω–∏—è
function showTutorialStep() {
  removeHighlight();

  if (currentTutorialStep >= tutorialSteps.length) {
    finishTutorial();
    return;
  }

  const step = tutorialSteps[currentTutorialStep];
  tutorialTitle.textContent = step.title || "–ü–æ–¥—Å–∫–∞–∑–∫–∞";
  tutorialText.innerHTML = step.text;

  // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  tutorialModal.style.top = '50%';
  tutorialModal.style.left = '50%';
  tutorialModal.style.transform = 'translate(-50%, -50%)';

  if (step.elementId) {
    const target = document.getElementById(step.elementId);
    if (target) {
      highlightedElement = target;
      highlightedElement.classList.add('tutorial-highlight');

      // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Ä–æ–¥–∏—Ç–µ–ª–µ–π –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
      let parent = target.parentElement;
      while (parent && parent !== document.body) {
        parent.classList.add('tutorial-highlighted-ancestor');
        highlightedAncestors.push(parent);
        parent = parent.parentElement;
      }

      target.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });

      setTimeout(() => {
        positionModalNearElement(target);
      }, 100);

    } else {
      console.warn(`–≠–ª–µ–º–µ–Ω—Ç —Å ID "${step.elementId}" –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
    }
  }

  tutorialNextBtn.textContent = (currentTutorialStep === tutorialSteps.length - 1) ? "–ó–∞–≤–µ—Ä—à–∏—Ç—å" : "–î–∞–ª–µ–µ";
}

// –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä—è–¥–æ–º —Å —ç–ª–µ–º–µ–Ω—Ç–æ–º
function positionModalNearElement(element) {
  const targetRect = element.getBoundingClientRect();
  const modalRect = tutorialModal.getBoundingClientRect();
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;

  let top = targetRect.bottom + 15;
  let left = targetRect.left + (targetRect.width / 2) - (modalRect.width / 2);

  if (top + modalRect.height > viewportHeight - 10) {
    top = targetRect.top - modalRect.height - 15;
  }
  if (top < 10) top = 10;

  if (left + modalRect.width > viewportWidth - 10) {
    left = viewportWidth - modalRect.width - 10;
  }
  if (left < 10) left = 10;

  tutorialModal.style.top = `${top}px`;
  tutorialModal.style.left = `${left}px`;
  tutorialModal.style.transform = 'translate(0, 0)';
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –î–∞–ª–µ–µ –∏ –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å
tutorialNextBtn.addEventListener('click', () => {
  currentTutorialStep++;
  showTutorialStep();
});

tutorialSkipBtn.addEventListener('click', () => {
  finishTutorial(true);
});

// –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–±—É—á–µ–Ω–∏—è
async function finishTutorial(skipped = false) {
  tutorialModalOverlay.style.display = 'none';
  tutorialModal.style.display = 'none';
  document.body.classList.remove('tutorial-active');
  removeHighlight();

  console.log(skipped ? "–û–±—É—á–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ." : "–û–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.");

  if (!telegramUser?.id || !supabaseClient) {
    console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –æ–±—É—á–µ–Ω–∏—è: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –∫–ª–∏–µ–Ω—Ç Supabase.");
    return;
  }

  try {
    const { data, error } = await supabaseClient
      .from('users')
      .upsert({ telegram_id: telegramUser.id.toString(), tutor: true }, { onConflict: 'telegram_id' })
      .select();

    if (error) {
      console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –æ–±—É—á–µ–Ω–∏—è –≤ Supabase:", error);
    } else {
      console.log("–°—Ç–∞—Ç—É—Å –æ–±—É—á–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω:", data);
    }
  } catch (e) {
    console.error("–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –æ–±—É—á–µ–Ω–∏—è:", e);
  }
}

// --- –ö–û–ù–ï–¶ –ë–õ–û–ö–ê –û–ë–£–ß–ï–ù–ò–Ø ---


// ... (rest of the script remains the same) ...
let jsonData = [];
let currentAlgorithm = "SHA-256";
let dailyIncome = 0;
let dailyProfitValue = 0;
let dailyElectricityCostValue = 0;
let monthlyProfit = 0;
let yearlyProfit = 0;
let usdtPrice = 0;
let isUSD = true;
let currentModelVariants = [];

document.addEventListener("DOMContentLoaded", initAppAndTutorial);

async function fetchData() {
    console.log("–ó–∞–≥—Ä—É–∑–∫–∞ kursBTC.txt...");
    try {
        const response = await fetch("https://hamsauno.github.io/Miner/kursBTC.txt");
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const text = await response.text();
        const data = text.trim().split("\n");
        console.log("‚úÖ –°—Ç—Ä–æ–∫–∏ –∏–∑ kursBTC.txt:", data);
        if (data.length >= 9) {
            const values = {
                btcPrice: parseFloat(data[0]), usdtPrice: parseFloat(data[1]), profitPerTH: parseFloat(data[2]),
                ltcPrice: parseFloat(data[3]), dogePrice: parseFloat(data[4]), bellPrice: parseFloat(data[5]),
                profitPerLTC: parseFloat(data[6]), profitPerDOGE: parseFloat(data[7]), profitPerBELL: parseFloat(data[8]),
            };
            Object.entries(values).forEach(([key, val]) => {
                if (isNaN(val)) console.warn(`‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è ${key} –∏–∑ TXT:`, data[Object.keys(values).indexOf(key)]);
                const el = document.getElementById(key);
                if (el && !isNaN(val)) {
                    el.value = val.toFixed(key.startsWith("profit") ? 8 : 2);
                    if (key === "usdtPrice") usdtPrice = val;
                } else if (!el) console.warn(`‚ö†Ô∏è –≠–ª–µ–º–µ–Ω—Ç —Å ID ${key} –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
            });
            if (Object.values(values).some(isNaN)) console.warn("–í–Ω–∏–º–∞–Ω–∏–µ: –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ kursBTC.txt –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.");
            else console.log("üì• –ó–Ω–∞—á–µ–Ω–∏—è –∏–∑ TXT —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.");
            if (usdtPrice > 0) console.log(`–ö—É—Ä—Å USDT –æ–±–Ω–æ–≤–ª–µ–Ω: ${usdtPrice}`); else console.warn("–ö—É—Ä—Å USDT –Ω–µ–≤–∞–ª–∏–¥–µ–Ω –∏–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.");

        } else console.warn("‚ùó –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ç—Ä–æ–∫ –≤ kursBTC.txt.");
    } catch (e) {
        console.error("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ kursBTC.txt:", e);
        if(document.getElementById('calculateBtn')) document.getElementById('calculateBtn').disabled = true;
    }
}

async function fetchJsonData() {
    console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ calc.json...`);
    try {
        const response = await fetch("https://hamsauno.github.io/Miner/json/calc.json");
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        jsonData = data["–†–∞—Å—á—ë—Ç—ã"] || [];
        console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${jsonData.length} –≤—Å–µ–≥–æ –º–æ–¥–µ–ª–µ–π.`);
        if (jsonData.length === 0) console.warn(`‚ö†Ô∏è –ú–æ–¥–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ calc.json`);
    } catch (e) {
        console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ calc.json:`, e);
        jsonData = [];
        if (document.getElementById("manufacturerSelect")) document.getElementById("manufacturerSelect").innerHTML = '<option>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
        if (document.getElementById("asicModel")) document.getElementById("asicModel").innerHTML = '<option>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
    }
}

async function onAlgorithmChange() {
    const algorithmSelect = document.getElementById("algorithmSelect");
    if (!algorithmSelect) return;
    currentAlgorithm = algorithmSelect.value;
    console.log(`–ê–ª–≥–æ—Ä–∏—Ç–º –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${currentAlgorithm}`);

    if (jsonData.length === 0) await fetchJsonData();

    const manufacturerSelect = document.getElementById("manufacturerSelect");
    if (!manufacturerSelect) return;

    const modelsForCurrentAlgorithm = jsonData.filter(item => item["–ê–ª–≥–æ—Ä–∏—Ç–º"] === currentAlgorithm);
    const uniqueManufacturers = [...new Set(modelsForCurrentAlgorithm.map(item => item["–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å"]?.toLowerCase() || 'unknown'))]
                                .filter(m => m !== 'unknown').sort();
    manufacturerSelect.innerHTML = "";
    if (uniqueManufacturers.length > 0) {
        uniqueManufacturers.forEach(m => {
            const opt = document.createElement("option");
            opt.value = m; opt.textContent = m.charAt(0).toUpperCase() + m.slice(1);
            manufacturerSelect.appendChild(opt);
        });
        manufacturerSelect.disabled = false;
        console.log(`–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏ –¥–ª—è ${currentAlgorithm} –æ–±–Ω–æ–≤–ª–µ–Ω—ã.`);
        updateModelList();
    } else {
        manufacturerSelect.innerHTML = '<option>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</option>'; manufacturerSelect.disabled = true;
        if (document.getElementById("asicModel")) { document.getElementById("asicModel").innerHTML = '<option>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</option>'; document.getElementById("asicModel").disabled = true; }
        updateAsicSpecs();
        console.warn(`–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏ –¥–ª—è ${currentAlgorithm} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.`);
    }
}

function updateModelList() {
    const manufacturerSelect = document.getElementById("manufacturerSelect");
    const modelSelect = document.getElementById("asicModel");
    if (!manufacturerSelect || !modelSelect) return;

    const selectedManufacturer = manufacturerSelect.value?.toLowerCase();
    modelSelect.innerHTML = "";

    const modelsFiltered = jsonData.filter(item => item["–ê–ª–≥–æ—Ä–∏—Ç–º"] === currentAlgorithm && item["–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å"]?.toLowerCase() === selectedManufacturer);
    const uniqueModels = [...new Set(modelsFiltered.map(item => item["–ú–æ–¥–µ–ª—å"]))].sort();

    if (uniqueModels.length > 0) {
        uniqueModels.forEach(modelName => {
            const opt = document.createElement("option");
            opt.value = modelName; opt.textContent = modelName; modelSelect.appendChild(opt);
        });
        modelSelect.disabled = false;
    } else {
        modelSelect.innerHTML = '<option>–ù–µ—Ç –º–æ–¥–µ–ª–µ–π</option>'; modelSelect.disabled = true;
    }
    updateAsicSpecs();
}

function updateAsicSpecs() {
    const modelSelect = document.getElementById("asicModel");
    const asicCostInput = document.getElementById("asicCost");
    const hashrateContainer = document.getElementById("hashrateContainer");
    const powerEl = document.getElementById("power");
    const powerUnitEl = document.getElementById("power_unit");

    hashrateContainer.innerHTML = '<span id="hashrate"></span><span id="edprice"></span>';
    document.getElementById("hashrate").textContent = '';
    document.getElementById("edprice").textContent = '';
    powerEl.textContent = ''; powerUnitEl.textContent = '';
    asicCostInput.value = ''; asicCostInput.placeholder = '–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å';
    currentModelVariants = [];

    const selectedModelName = modelSelect.value;
    if (!selectedModelName || modelSelect.selectedOptions.length === 0 || modelSelect.selectedOptions[0].disabled || modelSelect.selectedOptions[0].textContent.startsWith("–ù–µ—Ç")) {
        return;
    }

    currentModelVariants = jsonData.filter(i => i["–ú–æ–¥–µ–ª—å"] === selectedModelName && i["–ê–ª–≥–æ—Ä–∏—Ç–º"] === currentAlgorithm);
    currentModelVariants.sort((a, b) => parseFloat(b["–•–µ—à—Ä–µ–π—Ç"]) - parseFloat(a["–•–µ—à—Ä–µ–π—Ç"]));

    if (currentModelVariants.length > 0) {
        if (currentModelVariants.length === 1) {
            const item = currentModelVariants[0];
            document.getElementById("hashrate").textContent = item["–•–µ—à—Ä–µ–π—Ç"] || '';
            document.getElementById("edprice").textContent = item["–ï–¥. –∏–∑–º."] || '';
            populateSpecsForVariant(item);
        } else {
            let selectHTML = '<select id="hashrateSelect">';
            currentModelVariants.forEach((variant, index) => {
                selectHTML += `<option value="${index}">${variant["–•–µ—à—Ä–µ–π—Ç"]} ${variant["–ï–¥. –∏–∑–º."]}</option>`;
            });
            selectHTML += '</select>';
            hashrateContainer.innerHTML = selectHTML;
            document.getElementById("hashrateSelect").addEventListener('change', function() {
                populateSpecsForVariant(currentModelVariants[this.value]);
            });
            populateSpecsForVariant(currentModelVariants[0]);
        }
    } else {
        asicCostInput.placeholder = '–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
    }
}

function populateSpecsForVariant(item) {
    const powerEl = document.getElementById("power");
    const powerUnitEl = document.getElementById("power_unit");
    const asicCostInput = document.getElementById("asicCost");
    if (!item) {
        powerEl.textContent = ''; powerUnitEl.textContent = '';
        asicCostInput.value = ''; asicCostInput.placeholder = '–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
        return;
    }
    const powerValue = parseFloat(item["–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ"]);
    powerEl.textContent = isNaN(powerValue) ? '' : Math.round(powerValue);
    powerUnitEl.textContent = isNaN(powerValue) ? '' : ' –í—Ç';

    const itemPriceUSD = parseFloat(item["–¶–µ–Ω–∞"]);
    if (!isNaN(itemPriceUSD) && usdtPrice > 0) {
        asicCostInput.value = Math.ceil((itemPriceUSD * usdtPrice) / 100) * 100;
    } else {
        asicCostInput.value = '';
        asicCostInput.placeholder = (usdtPrice <= 0 && !isNaN(itemPriceUSD)) ? '–ö—É—Ä—Å USDT?' : '–¶–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞';
    }
}

function showNotification() {
    const notification = document.getElementById('notification');
    if(notification) { notification.classList.remove('hidden'); setTimeout(() => notification.classList.add('hidden'), 1000); }
}

function calculateProfit() {
    const elements = {
        usdtPriceInput: document.getElementById("usdtPrice"), powerEl: document.getElementById("power"),
        electricityCostInput: document.getElementById('electricityCost'), asicCostInput: document.getElementById("asicCost"),
        btcPriceInput: document.getElementById("btcPrice"), profitPerTHInput: document.getElementById("profitPerTH"),
        ltcPriceInput: document.getElementById("ltcPrice"), dogePriceInput: document.getElementById("dogePrice"),
        bellPriceInput: document.getElementById("bellPrice"), profitPerLTCInput: document.getElementById("profitPerLTC"),
        profitPerDOGEInput: document.getElementById("profitPerDOGE"), profitPerBELLInput: document.getElementById("profitPerBELL"),
        incomeEl: document.getElementById("income"), incomeRubEl: document.getElementById("income_rub"),
        profitEl: document.getElementById("profit"), profitRubEl: document.getElementById("profit_rub"),
        incomeMonthEl: document.getElementById("incomeMonth"), incomeMonthRubEl: document.getElementById("incomeMonth_rub"),
        incomeYearEl: document.getElementById("incomeYear"), incomeYearRubEl: document.getElementById("incomeYear_rub"),
        profitMonthEl: document.getElementById("profitMonth"), profitMonthRubEl: document.getElementById("profitMonth_rub"),
        profitYearEl: document.getElementById("profitYear"), profitYearRubEl: document.getElementById("profitYear_rub"),
        roiEl: document.getElementById("roi"), paybackEl: document.getElementById("payback"),
        profitBar: document.getElementById("dailyProfitBar"), electricityBar: document.getElementById("dailyElectricityCostBar"),
        profitPercentageLabel: document.getElementById("profitPercentageLabel"), costPercentageLabel: document.getElementById("costPercentageLabel")
    };
    if (Object.values(elements).some(el => !el)) { console.error("‚ùå –û—à–∏–±–∫–∞: –û–¥–∏–Ω –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω!"); return; }

    let actualHashrate, selectedVariantHashrateUnit = '';
    const hashrateSelect = document.getElementById("hashrateSelect");
    if (hashrateSelect && currentModelVariants.length > 0 && hashrateSelect.value !== "") {
        const selectedVariant = currentModelVariants[hashrateSelect.value];
        if (selectedVariant) { actualHashrate = parseFloat(selectedVariant["–•–µ—à—Ä–µ–π—Ç"]); selectedVariantHashrateUnit = selectedVariant["–ï–¥. –∏–∑–º."]; }
        else { console.error("‚ùå –û—à–∏–±–∫–∞: –í—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Ö–µ—à—Ä–µ–π—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω."); return; }
    } else {
        const hs = document.getElementById("hashrate"); const edp = document.getElementById("edprice");
        if (hs) actualHashrate = parseFloat(hs.textContent); else { console.error("‚ùå –û—à–∏–±–∫–∞: –≠–ª–µ–º–µ–Ω—Ç —Ö–µ—à—Ä–µ–π—Ç–∞ #hashrate –Ω–µ –Ω–∞–π–¥–µ–Ω."); return; }
        if (edp) selectedVariantHashrateUnit = edp.textContent;
    }

    let calculationHashrate = actualHashrate;
    if (currentAlgorithm === "SHA-256" && selectedVariantHashrateUnit) {
        if (selectedVariantHashrateUnit.toUpperCase().includes("PH")) calculationHashrate *= 1000;
        else if (selectedVariantHashrateUnit.toUpperCase().includes("GH")) calculationHashrate /= 1000;
        else if (selectedVariantHashrateUnit.toUpperCase().includes("MH")) calculationHashrate /= 1000000;
    }

    const values = {
        currentUsdtPrice: parseFloat(elements.usdtPriceInput.value), hashrate: calculationHashrate,
        power: parseFloat(elements.powerEl.textContent), electricityCost: parseFloat(elements.electricityCostInput.value.replace(',', '.')),
        asicCost: parseFloat(elements.asicCostInput.value)
    };
    if (Object.values(values).some(isNaN) || values.currentUsdtPrice <= 0 || values.hashrate <= 0) { console.error("‚ùå –û—à–∏–±–∫–∞: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –±–∞–∑–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞.", values); return; }

    dailyIncome = 0;
    if (currentAlgorithm === "SHA-256") {
        const btcP = parseFloat(elements.btcPriceInput.value), pPTH = parseFloat(elements.profitPerTHInput.value);
        if (!isNaN(btcP) && !isNaN(pPTH)) dailyIncome = values.hashrate * pPTH * btcP; else { console.error("‚ùå SHA-256 calc error"); return;}
    } else if (currentAlgorithm === "Scrypt") {
        const ltcP = parseFloat(elements.ltcPriceInput.value), dogeP = parseFloat(elements.dogePriceInput.value), bellP = parseFloat(elements.bellPriceInput.value);
        const pPLTC = parseFloat(elements.profitPerLTCInput.value), pPDOGE = parseFloat(elements.profitPerDOGEInput.value), pPBELL = parseFloat(elements.profitPerBELLInput.value);
        if (![ltcP, dogeP, bellP, pPLTC, pPDOGE, pPBELL].some(isNaN)) {
            dailyIncome = values.hashrate * (pPLTC * ltcP + pPDOGE * dogeP + pPBELL * bellP);
        } else { console.error("‚ùå Scrypt calc error"); return;}
    }

    dailyElectricityCostValue = (values.power / 1000) * values.electricityCost * 24 / values.currentUsdtPrice;
    window.dailyProfitValue = dailyIncome - dailyElectricityCostValue;
    monthlyProfit = window.dailyProfitValue * 30.5; yearlyProfit = window.dailyProfitValue * 365;
    const asicCostInUSD = values.asicCost / values.currentUsdtPrice;
    const roi = (yearlyProfit && asicCostInUSD > 0) ? (yearlyProfit / asicCostInUSD) * 100 : 0;
    const payback = (window.dailyProfitValue > 0 && asicCostInUSD > 0) ? (asicCostInUSD / window.dailyProfitValue) / 30.5 : Infinity;

    updateTableValues(); updateProgressBarAndLabels(elements);
    elements.roiEl.innerText = isFinite(roi) ? roi.toFixed(1) : "‚Äî";
    elements.paybackEl.innerText = isFinite(payback) ? payback.toFixed(1) : "‚Äî";
    showNotification();
}

function formatCurrency(value, currency = "$", fractionDigits = 2) {
    if (isNaN(value) || !isFinite(value)) return currency === "$" ? "$ --.--" : "--.-- ‚ÇΩ";
    return currency + (Math.round(value * Math.pow(10, fractionDigits)) / Math.pow(10, fractionDigits))
        .toLocaleString('ru-RU', { minimumFractionDigits: fractionDigits, maximumFractionDigits: fractionDigits });
}
function formatCurrencyRub(value, fractionDigits = 0) {
    if (isNaN(value) || !isFinite(value) || isNaN(usdtPrice) || usdtPrice <= 0) return "-- ‚ÇΩ";
    return (Math.round((value * usdtPrice) * Math.pow(10, fractionDigits)) / Math.pow(10, fractionDigits))
        .toLocaleString('ru-RU', { maximumFractionDigits: fractionDigits }) + " ‚ÇΩ";
}

function updateTableValues() {
    const ids = ["income", "incomeMonth", "incomeYear", "profit", "profitMonth", "profitYear"];
    ids.forEach(id => {
        const usdEl = document.getElementById(id), rubEl = document.getElementById(`${id}_rub`);
        if (usdEl && rubEl) {
            let valUSD = 0;
            if (id.startsWith("incomeMonth")) valUSD = dailyIncome * 30.5;
            else if (id.startsWith("incomeYear")) valUSD = dailyIncome * 365;
            else if (id.startsWith("income")) valUSD = dailyIncome;
            else if (id.startsWith("profitMonth")) valUSD = monthlyProfit;
            else if (id.startsWith("profitYear")) valUSD = yearlyProfit;
            else if (id.startsWith("profit")) valUSD = window.dailyProfitValue;
            usdEl.innerText = formatCurrency(valUSD); rubEl.innerText = formatCurrencyRub(valUSD);
            usdEl.classList.toggle("hidden", !isUSD); rubEl.classList.toggle("hidden", isUSD);
        }
    });
}

function setCurrency(setToUSD) {
    if (isUSD === setToUSD) return; isUSD = setToUSD;
    const usdBtn = document.getElementById('currencyUSD'), rubBtn = document.getElementById('currencyRUB');
    if (usdBtn && rubBtn) {
        usdBtn.classList.toggle('active', isUSD); usdBtn.classList.toggle('inactive', !isUSD);
        rubBtn.classList.toggle('active', !isUSD); rubBtn.classList.toggle('inactive', isUSD);
        updateTableValues();
    }
}

function updateProgressBarAndLabels(elements) {
    const { profitBar, electricityBar, profitPercentageLabel, costPercentageLabel } = elements;
    let profitPerc = 0, electricityPerc = 0;
    if (dailyIncome > 0 && isFinite(dailyIncome) && isFinite(dailyElectricityCostValue)) {
        profitPerc = Math.max(0, (window.dailyProfitValue / dailyIncome) * 100);
        electricityPerc = Math.max(0, (dailyElectricityCostValue / dailyIncome) * 100);
        if (window.dailyProfitValue <= 0) { profitPerc = 0; electricityPerc = 100; }
        else if (profitPerc + electricityPerc > 100.1) electricityPerc = 100 - profitPerc;
        profitPerc = Math.min(100, Math.max(0, profitPerc));
        electricityPerc = Math.min(100, Math.max(0, electricityPerc));
    }
    profitBar.style.width = `${profitPerc.toFixed(1)}%`;
    electricityBar.style.width = `${electricityPerc.toFixed(1)}%`;
    electricityBar.style.left = `${profitPerc.toFixed(1)}%`;
    profitPercentageLabel.textContent = `–ü—Ä–∏–±—ã–ª—å: ${profitPerc.toFixed(1)}%`;
    costPercentageLabel.textContent = `–ó–∞—Ç—Ä–∞—Ç—ã: ${electricityPerc.toFixed(1)}%`;
}

// Event Listeners
const algSel = document.getElementById("algorithmSelect"), manSel = document.getElementById("manufacturerSelect"),
      modSel = document.getElementById("asicModel"), calcBtn = document.getElementById("calculateBtn"),
      currUSD = document.getElementById('currencyUSD'), currRUB = document.getElementById('currencyRUB');

if (algSel) algSel.addEventListener("change", onAlgorithmChange);
if (manSel) manSel.addEventListener("change", updateModelList);
if (modSel) modSel.addEventListener("change", updateAsicSpecs);
if (calcBtn) calcBtn.addEventListener("click", calculateProfit);
if (currUSD) currUSD.addEventListener('click', () => setCurrency(true));
if (currRUB) currRUB.addEventListener('click', () => setCurrency(false));
</script>
</body>
</html>
